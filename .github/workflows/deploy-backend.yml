name: Deploy Backend to VPS

on:
  push:
    branches: ["main"]
    paths:
      - "backend/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy backend via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            # Couleurs
            RED='\033[0;31m'
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            NC='\033[0m'
            REPO_PATH="NohamDrive"

            echo -e "${YELLOW}=== D√©but du d√©ploiement du backend ===${NC}"
            if [ -d "$REPO_PATH" ]; then
              echo -e "${GREEN}‚úÖ D√©p√¥t trouv√©. Mise √† jour en cours...${NC}"
              cd "$REPO_PATH" || { echo -e "${RED}‚ùå Erreur : Impossible d'entrer dans $REPO_PATH${NC}"; exit 1; }
              git fetch origin || { echo -e "${RED}‚ùå Erreur lors du fetch${NC}"; exit 1; }
              git checkout main || { echo -e "${RED}‚ùå Erreur lors du checkout${NC}"; exit 1; }
              git pull origin main || { echo -e "${RED}‚ùå Erreur lors du pull${NC}"; exit 1; }
            else
              echo -e "${YELLOW}‚ö†Ô∏è  D√©p√¥t non trouv√©. Clonage en cours...${NC}"
              git clone "git@github.com:NoArAlMa/NohamDrive.git" || { echo -e "${RED}‚ùå Erreur lors du clone${NC}"; exit 1; }
              cd "$REPO_PATH" || { echo -e "${RED}‚ùå Erreur : Impossible d'entrer dans $REPO_PATH${NC}"; exit 1; }
            fi

            # Build et red√©marrage du conteneur backend
            echo -e "${YELLOW}üê≥ Construction de l'image Docker pour le backend...${NC}"
            docker compose -f docker-compose.backend.yml build || { echo -e "${RED}‚ùå Erreur lors du build Docker${NC}"; exit 1; }

            echo -e "${YELLOW}üîÑ Red√©marrage du conteneur backend...${NC}"
            docker compose -f docker-compose.backend.yml down || { echo -e "${RED}‚ùå Erreur lors de l'arr√™t du conteneur${NC}"; exit 1; }
            docker compose -f docker-compose.backend.yml up -d --remove-orphans || { echo -e "${RED}‚ùå Erreur lors du d√©marrage du conteneur${NC}"; exit 1; }

            # Nettoyage
            echo -e "${YELLOW}üßπ Nettoyage des images Docker inutilis√©es...${NC}"
            docker image prune -f || { echo -e "${RED}‚ùå Erreur lors du nettoyage${NC}"; exit 1; }

            # V√©rification finale
            if docker ps | grep -q "backend"; then
              echo -e "${GREEN}============================${NC}"
              echo -e "${GREEN}‚ú® D√©ploiement backend termin√© avec succ√®s ! ‚ú®${NC}"
              echo -e "${GREEN}============================${NC}"
            else
              echo -e "${RED}‚ùå √âCHEC : Le conteneur backend n'est pas d√©marr√©.${NC}"
              exit 1
            fi

name: Deploy to VPS

on:
  workflow_dispatch:  # Permet de d√©clencher manuellement
  push:
    branches: ["main", "dev/deploy"]  # D√©clenchement automatique sur push vers main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Docker and Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io docker-compose
          sudo systemctl enable docker
          sudo systemctl start docker

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            # Couleurs
            RED='\033[0;31m'
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            NC='\033[0m'
            REPO_PATH="NohamDrive"
            REPO_URL="git@github.com:NoArAlMa/NohamDrive.git"

            echo -e "${YELLOW}=== D√©but du d√©ploiement ===${NC}"

            # 1. Mise √† jour ou clonage du d√©p√¥t
            if [ -d "$REPO_PATH" ]; then
              echo -e "${GREEN}‚úÖ D√©p√¥t trouv√©. Mise √† jour en cours...${NC}"
              cd "$REPO_PATH" || { echo -e "${RED}‚ùå Erreur : Impossible d'entrer dans $REPO_PATH${NC}"; exit 1; }
              git fetch origin || { echo -e "${RED}‚ùå Erreur lors du fetch${NC}"; exit 1; }
              git checkout main || { echo -e "${RED}‚ùå Erreur lors du checkout${NC}"; exit 1; }
              git pull origin main || { echo -e "${RED}‚ùå Erreur lors du pull${NC}"; exit 1; }
            else
              echo -e "${YELLOW}‚ö†Ô∏è  D√©p√¥t non trouv√©. Clonage en cours...${NC}"
              git clone "$REPO_URL" || { echo -e "${RED}‚ùå Erreur lors du clone${NC}"; exit 1; }
              cd "$REPO_PATH" || { echo -e "${RED}‚ùå Erreur : Impossible d'entrer dans $REPO_PATH${NC}"; exit 1; }
            fi

            # 2. Build des images Docker
            echo -e "${YELLOW}üê≥ Construction des images Docker...${NC}"
            docker-compose build || { echo -e "${RED}‚ùå Erreur lors du build Docker${NC}"; exit 1; }

            # 3. Red√©marrage des conteneurs
            echo -e "${YELLOW}üîÑ Red√©marrage des conteneurs...${NC}"
            docker-compose down || { echo -e "${RED}‚ùå Erreur lors de l'arr√™t des conteneurs${NC}"; exit 1; }
            docker-compose up -d --remove-orphans || { echo -e "${RED}‚ùå Erreur lors du d√©marrage des conteneurs${NC}"; exit 1; }

            # 4. Nettoyage des images inutilis√©es
            echo -e "${YELLOW}üßπ Nettoyage des images Docker inutilis√©es...${NC}"
            docker image prune -f || { echo -e "${RED}‚ùå Erreur lors du nettoyage${NC}"; exit 1; }

            # 5. V√©rification finale
            if docker ps | grep -q "backend" && docker ps | grep -q "frontend"; then
              echo -e "${GREEN}============================${NC}"
              echo -e "${GREEN}‚ú® D√©ploiement termin√© avec succ√®s ! ‚ú®${NC}"
              echo -e "${GREEN}============================${NC}"
            else
              echo -e "${RED}‚ùå √âCHEC : Les conteneurs ne sont pas d√©marr√©s.${NC}"
              exit 1
            fi
